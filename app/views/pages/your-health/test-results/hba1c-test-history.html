{% extends 'layout-app.html' %}

{% set hub = "Your health" %}

{% set backLink = true %}
{% set backLinkText = "Back" %}

{% set pageHeading = "Your Haemoglobin A1c (HbA1c) estimation history" %}



{% block content %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">

      <!-- DYNAMIC PAGE TITLE -->
      {{ dynamicPageTitle({
        title: pageHeading
    })}}

    <div class="nhsuk-grid-column-full">
      <div style="width: 400px;">
        <div id="chartjs-tooltip" style="border:1px solid black; padding: 5px; margin-bottom: 20px"></div>
        <div style="width: 400px; height: 500px">
          <canvas id="graph" aria-label="This is the graph of your hb1ac. To be completed later."></canvas>
        </div>
      </div>
    </div>

    <div style="padding-bottom: 16px;">
      <h3>Your result history</h3>
        <p class="nhsuk-body-m">The table below shows your haemoglobin A1c (HbA1c) results over the last 6 months.
            <br><br>
            The reference range for a haemoglobin A1c (HbA1c) test is from 20 to 42 mmol/mol. This range is based on your most recent test result.</p>
    </div>
    <div>
        <table class="nhsuk-table">
            <thead role="rowgroup" class="nhsuk-table__head">
              <tr role="row">
                <th role="columnheader" class="" scope="col">
                  Date
                </th>
                <th role="columnheader" class="" scope="col">
                  Result (g/L)
                </th>
              </tr>
            </thead>
            <tbody class="nhsuk-table__body">
              <tr role="row" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">12 February 2024</td>
                <td class="nhsuk-table__cell ">46
                    <br>
                    <p class="nhsuk-body-s">(Within reference range)</p>
                </td>
              </tr>
              <tr role="row" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">12 January 2024</td>
                <td class="nhsuk-table__cell ">41
                    <br>
                    <p class="nhsuk-body-s">(Within reference range)</p>
                </td>
              </tr>
              <tr role="row" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">2 January 2024</td>
                <td class="nhsuk-table__cell ">39
                    <br>
                    <p class="nhsuk-body-s">(Within reference range)</p>
                </td>
              </tr>
              <tr role="row" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">6 December 2023</td>
                <td class="nhsuk-table__cell ">46
                    <br>
                    <p class="nhsuk-body-s">(Outside reference range)</p>
                </td>
              </tr>
              <tr role="row" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">21 November 2023</td>
                <td class="nhsuk-table__cell ">40
                    <br>
                    <p class="nhsuk-body-s">(Within reference range)</p>
                </td>
              </tr>
              <tr role="row" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">8 November 2023</td>
                <td class="nhsuk-table__cell ">39
                    <br>
                    <p class="nhsuk-body-s">(Within reference range)</p>
                </td>
              </tr>
              <tr role="row" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">26 September 2023</td>
                <td class="nhsuk-table__cell ">54
                    <br>
                    <p class="nhsuk-body-s">(Outside reference range)</p>
                </td>
              </tr>
              <tr role="row" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">16 September 2023</td>
                <td class="nhsuk-table__cell ">48
                    <br>
                    <p class="nhsuk-body-s">(Outside reference range)</p>
                </td>
              </tr>
            </tbody>
          </table>
    </div>

    {% endblock %}

    {% block pageScripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

    <script>
const data = [
      { date: '2023-09-16', value: 48 },
      { date: '2023-09-26', value: 54 },
      { date: '2023-11-08', value: 39 },
      { date: '2023-11-21', value: 40 },
      { date: '2023-12-06', value: 46 },
      { date: '2024-01-02', value: 39 },
      { date: '2024-01-12', value: 41 },
      { date: '2024-02-12', value: 46 },
    ];

    let lastIndex = 7;
    let firstLoad = true;

    // eslint-disable-next-line no-new
    var chart = new Chart(
      document.getElementById('graph'),
      {
        type: 'line',
        options: {
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            title: {
              text: 'Haemoglobin A1c (HbA1c) - (mmol/mol)',
              align: 'start',
              display: true,
              font: {
                  size: 16,
                  weight: 'bold',
                },
                padding: {
                  bottom: 20,
                },
            },
            legend: {
              display: false,
            },
            tooltip: {
                // Disable the on-canvas tooltip
                enabled: false,

                external: function(context) {
                    // Tooltip Element
                    let tooltipEl = document.getElementById('chartjs-tooltip');
                    const tooltipModel = context.tooltip;

                    let index = tooltipModel.dataPoints[0].dataIndex;
                    let activeElements = tooltipModel.getActiveElements();
                    console.log(activeElements);
                    
                    // If moving off point do nothing
                    if (tooltipModel.opacity === 0) {
                        return;
                    }

                    console.log(activeElements[0]);
                    console.log(index);

                    if(activeElements[0].index === lastIndex && !firstLoad) {
                      console.log('same active element - return');
                      return;
                    }

                    if(firstLoad) {
                      firstLoad = false;
                    }

                    // Set Text
                    const title = tooltipModel.title[0] || '';
                    const value = tooltipModel.dataPoints[0].formattedValue;

                    let innerHtml = "";
                    innerHtml += '<span style="color: gray">' + title + '</span>';
                    innerHtml += '<p style="color: black; margin-bottom: 0px">' + value + " mmol/mol" + '</p>';
                    tooltipEl.innerHTML = innerHtml;

                    lastIndex = tooltipModel.dataPoints[0].dataIndex;

                    // adjust point size
                    console.log(index);
                    const pointSizeArray = [...Array(data.length)].map((_, i) => {
                      if(i === index) return 8;
                      else return 4;
                    });
                    console.log(pointSizeArray);
                    tooltipModel.dataPoints[0].dataset.pointRadius = pointSizeArray;

                    context.chart.tooltip.setActiveElements([{
                      datasetIndex: 0,
                      index: index,
                    }]);

                    context.chart.update();
                }
            },
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'day',
                displayFormats: {
                day: 'MMM',
                },
                tooltipFormat: 'DD MMMM yyyy',
              },
              border: {
                color: '#000000',
                width: 2,
              },
              title: {
                display: true,
                align: 'start',
                text: 'Last 6 months',
                padding: 10,
                font: {
                  size: 16,
                  weight: 'bold',
                }
              },
              min: '2023-09-01',
              max: '2024-03-01',
              ticks: {
                stepSize: 1,
                callback: function(value, index, ticks) {

                  let date = moment(value);
                    if(date.date() === 1)
                      return date.format('MMM');
                    
                    if(date.date() === 16)
                    {                    
                      return '';
                    }
                    
                    return undefined;
                },
              },
              grid: {
                tickWidth: 2,
                tickLength: 8,
                tickColor: '#000000',
              },
            },
            y: {
              max: 100,
              min: 0,
              border: {
                color: '#000000',
                width: 2,
              },
              grid: {
                tickWidth: 2,
                tickLength: 8,
                tickColor: '#000000',
              },
              ticks: {
                // Remove the bottom tick mark on the y axis.
                callback: function(value, index) {
                  if (index === 0) return undefined;
                  else return value;
                }
              },
            },
          },
        },
        data: {
          labels: data.map(row => row.date),
          datasets: [
            {
              label: 'hb1ac',
              data: data.map(row => row.value),
              borderColor: '#000000',
              borderWidth: 1,
              pointRadius: 4,
              pointHoverRadius: 8,
              pointBackgroundColor: '#000000',
            }
          ],
        },
      },
    );

    const numberOfElements = chart.data.datasets[0].data.length
    if (numberOfElements) {
      chart.setActiveElements([
        { datasetIndex: 0, index: numberOfElements - 1 },
      ]);
      chart.tooltip.setActiveElements([
        { datasetIndex: 0, index: numberOfElements - 1 },
      ]);
      chart.update();
    }


</script>

  {% endblock %}
